generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// Auth.js Models (Required)
// =============================================================================

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// =============================================================================
// User Model
// =============================================================================

model User {
  id                     String   @id
  name                   String?
  email                  String?  @unique
  emailVerified          DateTime?
  image                  String?
  username               String?  @unique
  displayName            String?
  bio                    String?
  avatarUrl              String?
  bannerUrl              String?
  species                String?
  fursuitPhotos          String[] @default([])
  socialLinks            Json?
  interests              String[] @default([])
  isPublic               Boolean  @default(true)
  locale                 String   @default("ko")
  lastActiveAt           DateTime @default(now())
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // Follow approval setting
  requiresFollowApproval Boolean @default(false)

  // v2 Profile enhancements
  languages          String[] @default(["ko"])
  lookingFor         String?
  isDiscoverable     Boolean  @default(true)
  approximateLocation Json?
  lastLocationUpdate DateTime?
  theme              Json?
  isAgeVerified      Boolean  @default(false)
  verifiedAt         DateTime?

  // Relations
  accounts    Account[]
  sessions    Session[]
  activities  Activity[]   @relation("ActorActivities")
  inboxItems  InboxItem[]
  attachments Attachment[]
  followers   Follow[]     @relation("Followers")
  following   Follow[]     @relation("Following")

  // Context system (v2)
  ownedContexts Context[]    @relation("ContextOwner")
  memberships   Membership[]
}

// =============================================================================
// Activity Model (ActivityPub-style)
// =============================================================================

/// Activity represents any action in the system (posts, likes, follows, etc.)
model Activity {
  id String @id @default(cuid())

  // Activity type
  type      ActivityType
  actorId   String
  actorType ActorType    @default(USER)
  actor     User         @relation("ActorActivities", fields: [actorId], references: [id], onDelete: Cascade)

  // Object
  objectType ObjectType?
  objectId   String?
  object     Json?

  // Target
  targetId   String?
  targetType String?

  // Context (optional)
  contextId String?
  context   Context? @relation("ContextActivities", fields: [contextId], references: [id], onDelete: SetNull)

  // Addressing (ActivityPub style)
  to String[] @default([])
  cc String[] @default([])

  // Threading
  inReplyTo  String?
  threadRoot String?
  parent     Activity?  @relation("Replies", fields: [inReplyTo], references: [id], onDelete: SetNull)
  replies    Activity[] @relation("Replies")

  // Content metadata
  sensitive Boolean @default(false)
  summary   String?
  language  String?

  // Engagement counters
  likesCount   Int @default(0)
  repliesCount Int @default(0)
  repostsCount Int @default(0)

  // Timestamps
  published DateTime  @default(now())
  updated   DateTime  @updatedAt
  editedAt  DateTime?

  // Soft delete
  deleted   Boolean   @default(false)
  deletedAt DateTime?

  // Relations
  inboxItems  InboxItem[]
  attachments Attachment[]

  @@index([actorId])
  @@index([objectType, objectId])
  @@index([type])
  @@index([published])
  @@index([inReplyTo])
  @@index([threadRoot])
  @@index([contextId, published])
  @@index([deleted, published])
}

// =============================================================================
// Inbox & Follow Models
// =============================================================================

/// InboxItem tracks delivery of activities to users' inboxes
model InboxItem {
  id String @id @default(cuid())

  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activityId String
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  read     Boolean       @default(false)
  readAt   DateTime?
  muted    Boolean       @default(false)
  category InboxCategory @default(DEFAULT)
  priority Int           @default(0)

  createdAt DateTime @default(now())

  @@unique([userId, activityId])
  @@index([userId, read])
  @@index([userId, category])
  @@index([userId, priority, createdAt])
  @@index([createdAt])
}

/// Follow represents a follow relationship between users
model Follow {
  id String @id @default(cuid())

  followerId  String
  follower    User   @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  followingId String
  following   User   @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)

  status     FollowStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  acceptedAt DateTime?

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@index([status])
}

/// Attachment stores file upload metadata
model Attachment {
  id String @id @default(cuid())

  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  activityId String?
  activity   Activity? @relation(fields: [activityId], references: [id], onDelete: SetNull)

  type         AttachmentType
  mimeType     String
  url          String
  thumbnailUrl String?

  filename String
  size     Int
  width    Int?
  height   Int?
  duration Int?
  blurhash String?
  alt      String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([activityId])
}

// =============================================================================
// Context System (v2)
// =============================================================================

/// Context is the unified abstraction for Events, Groups, and Conventions
model Context {
  id          String      @id @default(cuid())
  type        ContextType
  slug        String      @unique
  handle      String?     @unique
  name        String
  description String?     @db.Text
  avatarUrl   String?
  bannerUrl   String?

  ownerId String
  owner   User   @relation("ContextOwner", fields: [ownerId], references: [id])

  visibility Visibility @default(PUBLIC)
  joinPolicy JoinPolicy @default(OPEN)

  plugins  Json     @default("{}")
  features String[] @default([])

  isArchived Boolean   @default(false)
  archivedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships Membership[]
  activities  Activity[]   @relation("ContextActivities")

  @@index([type])
  @@index([ownerId])
  @@index([visibility])
  @@index([createdAt])
}

/// Membership represents a user's relationship to a Context
model Membership {
  id        String       @id @default(cuid())
  contextId String
  context   Context      @relation(fields: [contextId], references: [id], onDelete: Cascade)
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      MemberRole   @default(MEMBER)
  status    MemberStatus @default(APPROVED)

  permissions    Json?
  notifyPosts    Boolean @default(true)
  notifyMentions Boolean @default(true)
  notifyEvents   Boolean @default(true)
  pluginData     Json    @default("{}")

  joinedAt   DateTime  @default(now())
  approvedAt DateTime?
  approvedBy String?

  @@unique([contextId, userId])
  @@index([contextId, role])
  @@index([userId])
  @@index([status])
}

// =============================================================================
// Enums
// =============================================================================

enum ActivityType {
  CREATE
  UPDATE
  DELETE
  LIKE
  ANNOUNCE
  FOLLOW
  ACCEPT
  REJECT
  UNDO
  JOIN
  LEAVE
  INVITE
  RSVP
  CHECKIN
  FLAG
  BLOCK
}

enum ActorType {
  USER
  BOT
  SYSTEM
}

enum ObjectType {
  NOTE
  IMAGE
  EVENT
  USER
  ACTIVITY
  VIDEO
  ARTICLE
  POLL
  CONTEXT
}

enum InboxCategory {
  DEFAULT
  MENTION
  DM
  FOLLOW
  LIKE
  REPOST
  REPLY
  EVENT
  GROUP
  SYSTEM
}

enum FollowStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum AttachmentType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
}

enum ContextType {
  GROUP
  EVENT
  CONVENTION
  CHANNEL
}

enum Visibility {
  PUBLIC
  PRIVATE
  UNLISTED
}

enum JoinPolicy {
  OPEN
  APPROVAL
  INVITE
  CLOSED
}

enum MemberRole {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
  GUEST
}

enum MemberStatus {
  PENDING
  APPROVED
  BANNED
  LEFT
}
